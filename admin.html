<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>預約管理後台</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 改用 jsDelivr CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="min-h-screen bg-gray-50">
  <main class="mx-auto max-w-6xl px-4 py-8">
    <h1 class="text-xl font-semibold mb-4">預約管理後台</h1>

    <!-- 登入/註冊 -->
    <section id="viewAuth" class="max-w-md bg-white shadow rounded-xl p-6">
      <div class="flex gap-2 mb-4">
        <button id="tabSignIn" class="px-3 py-2 rounded bg-violet-600 text-white">登入</button>
        <button id="tabSignUp" class="px-3 py-2 rounded border">註冊（免確認）</button>
      </div>

      <form id="formSignIn" class="flex flex-col gap-3">
        <input id="inEmail" type="email" placeholder="you@example.com" class="border rounded px-3 py-2" required>
        <input id="inPass" type="password" placeholder="密碼（≥6 碼）" class="border rounded px-3 py-2" required>
        <button class="px-3 py-2 rounded bg-violet-600 text-white">登入</button>
      </form>

      <form id="formSignUp" class="flex flex-col gap-3 hidden">
        <input id="upEmail" type="email" placeholder="you@example.com" class="border rounded px-3 py-2" required>
        <input id="upPass" type="password" placeholder="密碼（≥6 碼）" class="border rounded px-3 py-2" required>
        <button class="px-3 py-2 rounded bg-violet-600 text-white w-full">建立帳號並登入</button>
      </form>

      <p id="authMsg" class="text-sm text-rose-600 mt-2"></p>
    </section>

    <!-- Dashboard -->
    <section id="viewDashboard" class="hidden mt-8">
      <div class="bg-white shadow rounded-xl p-4">
        <div class="flex justify-between items-center">
          <div class="text-gray-500 text-sm" id="whoami"></div>
          <button id="btnSignOut" class="px-3 py-2 rounded border">登出</button>
        </div>
      </div>

      <div class="bg-white shadow rounded-xl p-4 mt-4 overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left text-gray-500">
              <th class="px-3 py-2">日期</th>
              <th class="px-3 py-2">時段</th>
              <th class="px-3 py-2">姓名</th>
              <th class="px-3 py-2">電話</th>
              <th class="px-3 py-2">備註</th>
              <th class="px-3 py-2">建立</th>
              <th class="px-3 py-2 text-right">操作</th>
            </tr>
          </thead>
          <tbody id="tbody" class="divide-y"></tbody>
        </table>
        <div id="empty" class="hidden text-gray-400 p-6 text-center">目前沒有資料</div>
      </div>
    </section>
  </main>

  <!-- 刪除確認 Modal -->
  <div id="modal" class="hidden fixed inset-0 bg-black/40 items-center justify-center">
    <div class="bg-white rounded-xl p-6 w-[90%] max-w-md">
      <h3 class="font-semibold mb-2">刪除預約</h3>
      <p class="text-sm text-gray-600 mb-4">確定要刪除此筆預約嗎？</p>
      <div class="flex justify-end gap-2">
        <button id="btnCancelDel" class="px-3 py-2 rounded border">取消</button>
        <button id="btnConfirmDel" class="px-3 py-2 rounded bg-rose-600 text-white">確定刪除</button>
      </div>
    </div>
  </div>

  <script>
    // --- 初始化 Supabase ---
    const sb = supabase.createClient(
      "https://cbebpuqfkprhamwsbhdb.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNiZWJwdXFma3ByaGFtd3NiaGRiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5NjAxODYsImV4cCI6MjA3MjUzNjE4Nn0.GceaTOKGxBb8kCERfw9-k_KsPGnrA_8pXwBaYFar99g"
    );

    // DOM
    const viewAuth = document.getElementById("viewAuth");
    const viewDashboard = document.getElementById("viewDashboard");
    const authMsg = document.getElementById("authMsg");
    const tabSignIn = document.getElementById("tabSignIn");
    const tabSignUp = document.getElementById("tabSignUp");
    const formSignIn = document.getElementById("formSignIn");
    const formSignUp = document.getElementById("formSignUp");
    const inEmail = document.getElementById("inEmail");
    const inPass = document.getElementById("inPass");
    const upEmail = document.getElementById("upEmail");
    const upPass = document.getElementById("upPass");
    const whoami = document.getElementById("whoami");
    const btnSignOut = document.getElementById("btnSignOut");

    const tbody = document.getElementById("tbody");
    const empty = document.getElementById("empty");
    const modal = document.getElementById("modal");
    const btnCancelDel = document.getElementById("btnCancelDel");
    const btnConfirmDel = document.getElementById("btnConfirmDel");
    let pendingDeleteId = null;

    // Tab
    tabSignIn.onclick = () => {
      tabSignIn.className = "px-3 py-2 rounded bg-violet-600 text-white";
      tabSignUp.className = "px-3 py-2 rounded border";
      formSignIn.classList.remove("hidden");
      formSignUp.classList.add("hidden");
      authMsg.textContent = "";
    };
    tabSignUp.onclick = () => {
      tabSignUp.className = "px-3 py-2 rounded bg-violet-600 text-white";
      tabSignIn.className = "px-3 py-2 rounded border";
      formSignUp.classList.remove("hidden");
      formSignIn.classList.add("hidden");
      authMsg.textContent = "";
    };

    // 初始化 session
    (async function init() {
      const { data: { session } } = await sb.auth.getSession();
      if (session) return ensureAdminThenShow(session);
      showAuth();
      sb.auth.onAuthStateChange((_evt, sess) => {
        if (sess) ensureAdminThenShow(sess);
      });
    })();

    function showAuth(msg) {
      viewAuth.classList.remove("hidden");
      viewDashboard.classList.add("hidden");
      if (msg) authMsg.textContent = msg;
    }

    async function ensureAdminThenShow(session) {
      try {
        const uid = session.user?.id;
        const { data, error } = await sb
          .from("admins")
          .select("user_id")
          .eq("user_id", uid)
          .maybeSingle();
        if (error) throw error;
        if (!data) {
          await sb.auth.signOut();
          return showAuth("這個帳號不在 admins 白名單，已登出。");
        }
        showDashboard(session);
      } catch (e) {
        console.error("白名單檢查失敗：", e);
        await sb.auth.signOut();
        showAuth("無法驗證管理員資格：" + (e?.message || e));
      }
    }

    function showDashboard(session) {
      viewAuth.classList.add("hidden");
      viewDashboard.classList.remove("hidden");
      whoami.textContent = session.user?.email || "";
      load();
      sb.channel("bookings-feed")
        .on("postgres_changes", { event: "*", schema: "public", table: "bookings" }, () => load())
        .subscribe();
    }

    // 註冊
    formSignUp.onsubmit = async (e) => {
      e.preventDefault();
      authMsg.textContent = "";
      const email = upEmail.value.trim();
      const password = upPass.value;
      let { error } = await sb.auth.signUp({ email, password });
      if (error) {
        console.error("註冊錯誤：", error);
        authMsg.textContent = "註冊失敗：" + error.message;
        return;
      }
      const res = await sb.auth.signInWithPassword({ email, password });
      if (res.error) {
        console.error("註冊後登入錯誤：", res.error);
        authMsg.textContent = "登入失敗：" + res.error.message;
      }
    };

    // 登入
    formSignIn.onsubmit = async (e) => {
      e.preventDefault();
      authMsg.textContent = "";
      const email = inEmail.value.trim();
      const password = inPass.value;
      const { error } = await sb.auth.signInWithPassword({ email, password });
      if (error) {
        console.error("登入錯誤：", error);
        authMsg.textContent = "登入失敗：" + error.message;
      }
    };

    // 登出
    btnSignOut.onclick = async () => {
      await sb.auth.signOut();
      showAuth();
    };

    // 載入預約
    async function load() {
      const { data, error } = await sb
        .from("bookings")
        .select("*")
        .order("date", { ascending: true })
        .order("start_time", { ascending: true });
      if (error) return console.error("讀取 bookings 錯誤：", error);
      render(data || []);
    }

    function render(rows) {
      tbody.innerHTML = "";
      if (!rows.length) {
        empty.classList.remove("hidden");
        return;
      }
      empty.classList.add("hidden");
      for (const r of rows) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="px-3 py-2">${r.date}</td>
          <td class="px-3 py-2"><span class="px-2 py-1 rounded-full bg-emerald-100 text-emerald-700 text-xs">${r.start_time} – ${r.end_time}</span></td>
          <td class="px-3 py-2">${esc(r.name || "")}</td>
          <td class="px-3 py-2">${esc(r.phone || "")}</td>
          <td class="px-3 py-2">${esc(r.notes || "")}</td>
          <td class="px-3 py-2 text-gray-500">${fmt(r.created_at)}</td>
          <td class="px-3 py-2 text-right"><button data-id="${r.id}" class="px-3 py-1.5 rounded border text-rose-600">刪除</button></td>`;
        tr.querySelector("button")?.addEventListener("click", () => {
          pendingDeleteId = r.id;
          modal.classList.remove("hidden");
          modal.classList.add("flex");
        });
        tbody.appendChild(tr);
      }
    }

    // Modal
    btnCancelDel.onclick = () => {
      pendingDeleteId = null;
      modal.classList.add("hidden");
      modal.classList.remove("flex");
    };
    btnConfirmDel.onclick = async () => {
      if (!pendingDeleteId) return;
      const { error } = await sb.from("bookings").delete().eq("id", pendingDeleteId);
      pendingDeleteId = null;
      modal.classList.add("hidden");
      modal.classList.remove("flex");
      if (error) alert("刪除失敗：" + error.message);
      else load();
    };

    // 工具
    function esc(s) {
      const map = { "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" };
      return String(s).replace(/[&<>"']/g, (c) => map[c]);
    }
    function fmt(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      const p = (n) => String(n).padStart(2, "0");
      return d.getFullYear() + "-" + p(d.getMonth() + 1) + "-" + p(d.getDate()) + " " + p(d.getHours()) + ":" + p(d.getMinutes());
    }
  </script>
</body>
</html>