<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>預約管理｜漁人碼頭足球場</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <link rel="icon" href="./assets/favicon.svg" />
  <style>
    /* 蘋果風淡陰影與玻璃感 */
    .glass { backdrop-filter: blur(10px); background: rgba(255,255,255,.7); }
    .btn  { @apply px-4 py-2 rounded-xl font-medium transition; }
    .btn-primary { @apply bg-purple-600 text-white hover:bg-purple-700; }
    .btn-ghost   { @apply bg-white hover:bg-gray-100 border border-gray-200; }
    .chip { @apply inline-flex items-center px-2 py-1 rounded-full text-xs font-medium; }
    .chip-green { @apply bg-green-100 text-green-700; }
    .chip-purple{ @apply bg-purple-100 text-purple-700; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-50 via-white to-green-50 text-gray-800">

  <!-- Header -->
  <header class="sticky top-0 z-30 bg-white/70 glass border-b border-gray-100">
    <div class="mx-auto max-w-6xl px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="./assets/logo.svg" alt="FWFS" class="h-8 w-8 hidden sm:block" onerror="this.src='./assets/logo.png'">
        <div>
          <h1 class="text-lg sm:text-xl font-semibold">漁人碼頭足球場｜預約管理</h1>
          <p class="text-xs sm:text-sm text-gray-500">Fisherman’s Wharf Football Stadium</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <span id="whoami" class="hidden text-sm text-gray-500"></span>
        <button id="btnSignOut" class="btn btn-ghost hidden">登出</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="mx-auto max-w-6xl px-4 py-8">

    <!-- 未登入：Email 魔術連結 -->
    <section id="viewSignIn" class="max-w-xl mx-auto glass rounded-2xl p-8 shadow-sm">
      <h2 class="text-2xl font-bold mb-2">管理員登入</h2>
      <p class="text-gray-500 mb-6">輸入你的 Email，我們會寄送一次性登入連結（Magic Link）。</p>
      <form id="formSignIn" class="flex flex-col gap-4">
        <input id="signinEmail" type="email" required placeholder="you@example.com"
               class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-300">
        <button class="btn btn-primary w-full">寄送登入連結</button>
      </form>
      <p id="signinMsg" class="mt-4 text-sm text-gray-600"></p>

      <div class="mt-6 text-xs text-gray-500">
        限管理員信箱可編輯/刪除預約。若收不到信，請在 Supabase 的
        <span class="chip chip-purple">Authentication → Emails</span>
        設定 SMTP，或檢查垃圾郵件。
      </div>
    </section>

    <!-- 已登入：後台儀表 -->
    <section id="viewDashboard" class="hidden space-y-6">

      <!-- 控制列 -->
      <div class="glass rounded-2xl p-5 shadow-sm">
        <div class="flex flex-col md:flex-row gap-4 md:items-end md:justify-between">
          <div class="flex flex-col md:flex-row gap-4 md:items-end">
            <div>
              <label class="block text-sm text-gray-500 mb-1">日期</label>
              <input id="filterDate" type="date"
                     class="px-4 py-2.5 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-300">
            </div>
            <div>
              <label class="block text-sm text-gray-500 mb-1">搜尋（姓名/電話）</label>
              <input id="filterQuery" type="text" placeholder="例如：張三 或 6802"
                     class="px-4 py-2.5 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-300">
            </div>
            <div>
              <label class="block text-sm text-gray-500 mb-1">排序</label>
              <select id="sortBy" class="px-4 py-2.5 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-300">
                <option value="date-asc">日期 ↑ 時間 ↑</option>
                <option value="date-desc">日期 ↓ 時間 ↓</option>
              </select>
            </div>
          </div>

          <div class="flex gap-3">
            <button id="btnReload" class="btn btn-ghost">重新整理</button>
            <button id="btnExport" class="btn btn-primary">匯出 CSV</button>
          </div>
        </div>
      </div>

      <!-- 資訊/提示 -->
      <div id="tip" class="hidden glass rounded-xl p-4 text-sm text-purple-700 border border-purple-100">
        已套用資料篩選或搜尋結果。
      </div>

      <!-- 清單 -->
      <div class="glass rounded-2xl shadow-sm overflow-hidden">
        <table class="min-w-full">
          <thead class="bg-gray-50/70">
            <tr class="text-left text-xs uppercase tracking-wider text-gray-500">
              <th class="px-4 py-3">日期</th>
              <th class="px-4 py-3">時段</th>
              <th class="px-4 py-3">姓名</th>
              <th class="px-4 py-3">電話</th>
              <th class="px-4 py-3">建立</th>
              <th class="px-4 py-3 text-right">操作</th>
            </tr>
          </thead>
          <tbody id="tbody" class="divide-y divide-gray-100 bg-white/60"></tbody>
        </table>
        <div id="empty" class="hidden p-10 text-center text-gray-500">目前沒有資料</div>
      </div>
    </section>
  </main>

  <!-- 刪除確認 Modal -->
  <div id="modal" class="hidden fixed inset-0 z-40 flex items-center justify-center bg-black/30 p-4">
    <div class="bg-white rounded-2xl max-w-md w-full p-6 shadow-lg">
      <h3 class="text-lg font-semibold mb-2">刪除預約</h3>
      <p class="text-sm text-gray-600 mb-6">確定要刪除此筆預約嗎？此動作無法復原。</p>
      <div class="flex justify-end gap-3">
        <button id="btnCancelDel" class="btn btn-ghost">取消</button>
        <button id="btnConfirmDel" class="btn btn-primary">確定刪除</button>
      </div>
    </div>
  </div>

  <script>
    // ====== Supabase 連線 ======
    const supabaseUrl = "https://cbebpuqfkprhamwsbhdb.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNiZWJwdXFma3ByaGFtd3NiaGRiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5NjAxODYsImV4cCI6MjA3MjUzNjE4Nn0.GceaTOKGxBb8kCERfw9-k_KsPGnrA_8pXwBaYFar99g";
    const sb = supabase.createClient(supabaseUrl, supabaseKey);

    // ====== DOM ======
    const viewSignIn  = document.getElementById('viewSignIn');
    const viewDashboard = document.getElementById('viewDashboard');
    const formSignIn = document.getElementById('formSignIn');
    const signinEmail = document.getElementById('signinEmail');
    const signinMsg   = document.getElementById('signinMsg');
    const whoami      = document.getElementById('whoami');
    const btnSignOut  = document.getElementById('btnSignOut');

    const filterDate  = document.getElementById('filterDate');
    const filterQuery = document.getElementById('filterQuery');
    const sortBy      = document.getElementById('sortBy');
    const btnReload   = document.getElementById('btnReload');
    const btnExport   = document.getElementById('btnExport');
    const tip         = document.getElementById('tip');
    const tbody       = document.getElementById('tbody');
    const empty       = document.getElementById('empty');

    const modal       = document.getElementById('modal');
    const btnCancelDel= document.getElementById('btnCancelDel');
    const btnConfirmDel= document.getElementById('btnConfirmDel');
    let pendingDeleteId = null;

    // ====== Session 控制 ======
    async function init() {
      const { data: { session } } = await sb.auth.getSession();
      session ? showDashboard(session) : showSignIn();

      // magic link 回跳時，Supabase 會自動吃 URL hash
      sb.auth.onAuthStateChange((_evt, sess) => {
        if (sess) showDashboard(sess);
      });

      // Realtime
      sb.channel('bookings-changes')
        .on('postgres_changes',
            { event: '*', schema: 'public', table: 'bookings' },
            () => load())
        .subscribe();
    }

    function showSignIn() {
      viewSignIn.classList.remove('hidden');
      viewDashboard.classList.add('hidden');
      whoami.classList.add('hidden');
      btnSignOut.classList.add('hidden');
    }

    function showDashboard(session) {
      viewSignIn.classList.add('hidden');
      viewDashboard.classList.remove('hidden');
      whoami.textContent = session.user?.email || '';
      whoami.classList.remove('hidden');
      btnSignOut.classList.remove('hidden');
      load();
    }

    // ====== 登入 / 登出 ======
    formSignIn.addEventListener('submit', async (e) => {
      e.preventDefault();
      signinMsg.textContent = '寄送中…';
      const email = signinEmail.value.trim();
      const { error } = await sb.auth.signInWithOtp({
        email,
        options: { emailRedirectTo: location.href }
      });
      if (error) {
        signinMsg.textContent = '寄送失敗：' + error.message;
        return;
      }
      signinMsg.textContent = '已寄出登入連結，請到信箱點擊連結完成登入。';
      formSignIn.reset();
    });

    btnSignOut.addEventListener('click', async () => {
      await sb.auth.signOut();
      showSignIn();
    });

    // ====== 讀取資料 ======
    async function load() {
      let query = sb.from('bookings').select('*');

      // 排序
      const sort = sortBy.value || 'date-asc';
      const [d, dir] = sort.split('-');
      const asc = dir === 'asc';
      query = query.order('date', { ascending: asc }).order('start_time', { ascending: asc });

      const { data, error } = await query;
      if (error) { console.error(error); return; }

      // 篩選/搜尋
      const q = (filterQuery.value || '').toLowerCase();
      const day = filterDate.value || '';
      const filtered = data.filter(row => {
        const hitQ = !q || row.name?.toLowerCase().includes(q) || row.phone?.toLowerCase().includes(q);
        const hitD = !day || row.date === day;
        return hitQ && hitD;
      });

      renderTable(filtered);
      tip.classList.toggle('hidden', !(q || day));
    }

    function renderTable(rows) {
      tbody.innerHTML = '';
      if (!rows.length) {
        empty.classList.remove('hidden');
        return;
      }
      empty.classList.add('hidden');

      for (const r of rows) {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50/70 text-sm';
        tr.innerHTML = `
          <td class="px-4 py-3">${r.date}</td>
          <td class="px-4 py-3">
            <span class="chip chip-green">${r.start_time} – ${r.end_time}</span>
          </td>
          <td class="px-4 py-3">${escapeHtml(r.name || '')}</td>
          <td class="px-4 py-3">${escapeHtml(r.phone || '')}</td>
          <td class="px-4 py-3 text-gray-500">${fmtTime(r.created_at)}</td>
          <td class="px-4 py-3 text-right">
            <button data-id="${r.id}" class="btn btn-ghost border border-red-200 text-red-600 hover:bg-red-50">刪除</button>
          </td>
        `;
        tr.querySelector('button')?.addEventListener('click', () => {
          pendingDeleteId = r.id;
          modal.classList.remove('hidden');
        });
        tbody.appendChild(tr);
      }
    }

    // ====== 刪除 ======
    btnCancelDel.addEventListener('click', () => {
      pendingDeleteId = null;
      modal.classList.add('hidden');
    });
    btnConfirmDel.addEventListener('click', async () => {
      if (!pendingDeleteId) return;
      const { error } = await sb.from('bookings').delete().eq('id', pendingDeleteId);
      modal.classList.add('hidden');
      pendingDeleteId = null;
      if (error) alert('刪除失敗：' + error.message);
      else load();
    });

    // ====== 匯出 CSV ======
    btnExport.addEventListener('click', async () => {
      const { data, error } = await sb
        .from('bookings')
        .select('*')
        .order('date', { ascending: true })
        .order('start_time', { ascending: true });
      if (error) return alert('匯出失敗：' + error.message);

      const rows = [['id','date','start_time','end_time','name','phone','created_at']];
      data.forEach(r => rows.push([r.id, r.date, r.start_time, r.end_time, r.name, r.phone, r.created_at]));
      const csv = rows.map(r => r.map(s => `"${String(s ?? '').replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `bookings-${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    // ====== 篩選/排序/刷新 ======
    filterDate.addEventListener('change', load);
    filterQuery.addEventListener('input', () => { debounce(load, 250)(); });
    sortBy.addEventListener('change', load);
    btnReload.addEventListener('click', load);

    // ====== utils ======
    function fmtTime(iso) {
      if (!iso) return '';
      const d = new Date(iso);
      const pad = n => String(n).padStart(2,'0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }
    function escapeHtml(s) {
      return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
    function debounce(fn, wait=200) {
      let t; return (...args) => { clearTimeout(t); t=setTimeout(()=>fn(...args), wait); };
    }

    init();
  </script>
</body>
</html>
