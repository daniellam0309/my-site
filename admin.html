<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>預約後台（免確認 + admins 白名單）</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    .glass { backdrop-filter: blur(10px); background: rgba(255,255,255,.75); }
    .btn { padding:.5rem .75rem; border-radius: .75rem; font-size:.9rem; font-weight:600; transition: .15s; }
    .btn-primary { background:#7c3aed; color:#fff; }
    .btn-ghost { background:#fff; border:1px solid #e5e7eb; }
    .chip { display:inline-flex; align-items:center; padding:.25rem .5rem; border-radius:999px; font-size:.75rem; font-weight:600; }
    .chip-green { background:#d1fae5; color:#065f46; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-50 via-white to-emerald-50 text-gray-800">
  <header class="sticky top-0 z-30 bg-white/70 glass border-b">
    <div class="mx-auto max-w-6xl px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <h1 class="text-lg sm:text-xl font-semibold">預約管理後台</h1>
        <span class="text-xs sm:text-sm text-gray-500">（admins 白名單）</span>
      </div>
      <div class="flex items-center gap-3">
        <span id="whoami" class="hidden text-sm text-gray-500"></span>
        <button id="btnSignOut" class="btn btn-ghost hidden">登出</button>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-6xl px-4 py-8">

    <!-- Auth -->
    <section id="viewAuth" class="max-w-xl mx-auto glass rounded-2xl p-8 shadow-sm">
      <p class="text-sm text-amber-700 bg-amber-50 border border-amber-200 rounded p-3 -mt-2 mb-4">
        若要免確認信生效，請在 Supabase → <b>Authentication → Providers → Email</b> 關閉 <b>Confirm email</b>。
        <br>此版本需要資料表 <code>admins(user_id uuid PK)</code>，並將管理員 user_id 加入白名單。
      </p>
      <div class="flex gap-2 mb-6">
        <button id="tabSignIn" class="btn btn-primary">登入</button>
        <button id="tabSignUp" class="btn btn-ghost">註冊（免確認）</button>
      </div>

      <!-- Sign In -->
      <form id="formSignIn" class="flex flex-col gap-3">
        <input id="inEmail" type="email" required placeholder="you@example.com"
               class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-300">
        <input id="inPass" type="password" required placeholder="密碼（≥6 碼）"
               class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-300">
        <button class="btn btn-primary w-full">登入</button>
      </form>

      <!-- Sign Up -->
      <form id="formSignUp" class="flex flex-col gap-3 hidden">
        <input id="upEmail" type="email" required placeholder="you@example.com"
               class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-300">
        <input id="upPass" type="password" required placeholder="密碼（≥6 碼）"
               class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-300">
        <button class="btn btn-primary w-full">建立帳號並直接登入</button>
      </form>

      <p id="authMsg" class="mt-3 text-sm text-rose-600"></p>
    </section>

    <!-- Dashboard -->
    <section id="viewDashboard" class="hidden space-y-6">
      <div class="glass rounded-2xl p-5 shadow-sm">
        <div class="flex flex-col md:flex-row gap-4 md:items-end md:justify-between">
          <div class="flex flex-col md:flex-row gap-4 md:items-end">
            <div>
              <label class="block text-sm text-gray-500 mb-1">日期</label>
              <input id="filterDate" type="date"
                     class="px-4 py-2.5 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-300">
            </div>
            <div>
              <label class="block text-sm text-gray-500 mb-1">搜尋（姓名/電話/備註）</label>
              <input id="filterQuery" type="text" placeholder="例如：張三 或 6802"
                     class="px-4 py-2.5 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-300">
            </div>
            <div>
              <label class="block text-sm text-gray-500 mb-1">排序</label>
              <select id="sortBy" class="px-4 py-2.5 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-300">
                <option value="asc">日期 ↑ 時間 ↑</option>
                <option value="desc">日期 ↓ 時間 ↓</option>
              </select>
            </div>
          </div>
          <div class="flex gap-3">
            <button id="btnReload" class="btn btn-ghost">重新整理</button>
            <button id="btnExport" class="btn btn-primary">匯出 CSV</button>
          </div>
        </div>
      </div>

      <div id="tip" class="hidden glass rounded-xl p-4 text-sm text-purple-700 border border-purple-100">
        已套用資料篩選或搜尋結果。
      </div>

      <div class="glass rounded-2xl shadow-sm overflow-hidden">
        <table class="min-w-full">
          <thead class="bg-gray-50/70">
            <tr class="text-left text-xs uppercase tracking-wider text-gray-500">
              <th class="px-4 py-3">日期</th>
              <th class="px-4 py-3">時段</th>
              <th class="px-4 py-3">姓名</th>
              <th class="px-4 py-3">電話</th>
              <th class="px-4 py-3">備註</th>
              <th class="px-4 py-3">建立</th>
              <th class="px-4 py-3 text-right">操作</th>
            </tr>
          </thead>
          <tbody id="tbody" class="divide-y divide-gray-100 bg-white/60"></tbody>
        </table>
        <div id="empty" class="hidden p-10 text-center text-gray-500">目前沒有資料</div>
      </div>
    </section>
  </main>

  <!-- 刪除確認 Modal -->
  <div id="modal" class="hidden fixed inset-0 z-40 flex items-center justify-center bg-black/30 p-4">
    <div class="bg-white rounded-2xl max-w-md w-full p-6 shadow-lg">
      <h3 class="text-lg font-semibold mb-2">刪除預約</h3>
      <p class="text-sm text-gray-600 mb-6" id="modalText">確定要刪除此筆預約嗎？此動作無法復原。</p>
      <div class="flex justify-end gap-3">
        <button id="btnCancelDel" class="btn btn-ghost">取消</button>
        <button id="btnConfirmDel" class="btn btn-primary">確定刪除</button>
      </div>
    </div>
  </div>

  <script>
    // ===== Supabase =====
    const sb = supabase.createClient("https://cbebpuqfkprhamwsbhdb.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNiZWJwdXFma3ByaGFtd3NiaGRiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5NjAxODYsImV4cCI6MjA3MjUzNjE4Nn0.GceaTOKGxBb8kCERfw9-k_KsPGnrA_8pXwBaYFar99g");

    // ===== DOM 元素 =====
    const viewAuth = document.getElementById('viewAuth');
    const tabSignIn = document.getElementById('tabSignIn');
    const tabSignUp = document.getElementById('tabSignUp');
    const formSignIn = document.getElementById('formSignIn');
    const formSignUp = document.getElementById('formSignUp');
    const inEmail = document.getElementById('inEmail');
    const inPass  = document.getElementById('inPass');
    const upEmail = document.getElementById('upEmail');
    const upPass  = document.getElementById('upPass');
    const authMsg = document.getElementById('authMsg');

    const viewDashboard = document.getElementById('viewDashboard');
    const whoami = document.getElementById('whoami');
    const btnSignOut = document.getElementById('btnSignOut');

    const filterDate  = document.getElementById('filterDate');
    const filterQuery = document.getElementById('filterQuery');
    const sortBy      = document.getElementById('sortBy');
    const btnReload   = document.getElementById('btnReload');
    const btnExport   = document.getElementById('btnExport');
    const tip         = document.getElementById('tip');
    const tbody       = document.getElementById('tbody');
    const empty       = document.getElementById('empty');

    const modal       = document.getElementById('modal');
    const btnCancelDel = document.getElementById('btnCancelDel');
    const btnConfirmDel = document.getElementById('btnConfirmDel');
    let pendingDeleteId = null;

    // ===== Tabs =====
    tabSignIn.addEventListener('click', () => { 
      tabSignIn.className = 'btn btn-primary'; tabSignUp.className='btn btn-ghost';
      formSignIn.classList.remove('hidden'); formSignUp.classList.add('hidden'); authMsg.textContent='';
    });
    tabSignUp.addEventListener('click', () => { 
      tabSignUp.className = 'btn btn-primary'; tabSignIn.className='btn btn-ghost';
      formSignUp.classList.remove('hidden'); formSignIn.classList.add('hidden'); authMsg.textContent='';
    });

    // ===== Session =====
    (async function init() { 
      const { data: { session } } = await sb.auth.getSession();
      if (session) return ensureAdminThenShow(session);
      showAuth();
      sb.auth.onAuthStateChange((_evt, sess) => { if (sess) ensureAdminThenShow(sess); });
    })();

    function showAuth(msg) { 
      viewAuth.classList.remove('hidden'); 
      viewDashboard.classList.add('hidden'); 
      whoami.classList.add('hidden'); 
      btnSignOut.classList.add('hidden');
      if (msg) authMsg.textContent = msg;
    }
    async function ensureAdminThenShow(session) {
      const uid = session.user?.id;
      try {
        const { data, error } = await sb.from('admins').select('user_id').eq('user_id', uid).maybeSingle();
        if (error) throw error;
        if (!data) { await sb.auth.signOut(); return showAuth('這個帳號不在 admins 白名單，已登出。'); }
        // ok
        showDashboard(session);
      } catch (e) {
        console.error(e);
        await sb.auth.signOut();
        showAuth('無法驗證管理員資格：' + (e?.message || e));
      }
    }
    function showDashboard(session) {
      viewAuth.classList.add('hidden'); 
      viewDashboard.classList.remove('hidden'); 
      whoami.textContent = session.user?.email || '';
      whoami.classList.remove('hidden'); 
      btnSignOut.classList.remove('hidden');
      load();
      // Realtime 監聽
      sb.channel('bookings-feed').on('postgres_changes', { event: '*', schema:'public', table:'bookings' }, () => load()).subscribe();
    }

    // ===== Auth（免確認）=====
    formSignUp.addEventListener('submit', async (e) => {
      e.preventDefault(); authMsg.textContent='';
      const email = upEmail.value.trim();
      const password = upPass.value;
      // 1) 註冊
      let { error } = await sb.auth.signUp({ email, password });
      if (error) return authMsg.textContent = '註冊失敗：' + error.message;
      // 2) 直接登入（需要在後台關閉 Confirm email）
      const res = await sb.auth.signInWithPassword({ email, password });
      if (res.error) return authMsg.textContent = '登入失敗（可能後台未關閉 Confirm email）：' + res.error.message;
      // 成功會觸發 onAuthStateChange → ensureAdminThenShow
    });

    formSignIn.addEventListener('submit', async (e) => {
      e.preventDefault(); authMsg.textContent='';
      const email = inEmail.value.trim();
      const password = inPass.value;
      const { error } = await sb.auth.signInWithPassword({ email, password });
      if (error) return authMsg.textContent = '登入失敗：' + error.message;
    });

    btnSignOut.addEventListener('click', async () => {
      await sb.auth.signOut(); showAuth();
    });

    // ===== Data =====
    async function load() {
      let query = sb.from('bookings').select('*');
      const ascending = (sortBy.value||'asc') === 'asc';
      query = query.order('date', { ascending }).order('start_time', { ascending });
      const { data, error } = await query;
      if (error) return console.error(error);

      // 本地篩選
      const kw = (filterQuery.value||'').toLowerCase();
      const day = filterDate.value||'';
      const rows = (data||[]).filter(r => 
        (!kw || (r.name||'').toLowerCase().includes(kw) || (r.phone||'').toLowerCase().includes(kw) || (r.notes||'').toLowerCase().includes(kw)) &&
        (!day || r.date===day)
      );
      render(rows);
      tip.classList.toggle('hidden', !(kw||day));
    }

    function render(rows) {
      tbody.innerHTML='';
      if (!rows.length) { empty.classList.remove('hidden'); return; }
      empty.classList.add('hidden');
      for (const r of rows) {
        const tr = document.createElement('tr'); tr.className='hover:bg-gray-50/70 text-sm';
        tr.innerHTML = `
          <td class="px-4 py-3">\${r.date}</td>
          <td class="px-4 py-3"><span class="chip chip-green">\${r.start_time} – \${r.end_time}</span></td>
          <td class="px-4 py-3">\${esc(r.name || "")}</td>
          <td class="px-4 py-3">\${esc(r.phone || "")}</td>
          <td class="px-4 py-3">\${esc(r.notes || "")}</td>
          <td class="px-4 py-3 text-gray-500">\${fmt(r.created_at)}</td>
          <td class="px-4 py-3 text-right"><button data-id="\${r.id}" class="btn btn-ghost" style="border:1px solid #fecaca;color:#dc2626;">刪除</button></td>`;
        tr.querySelector('button')?.addEventListener('click', () => { pendingDeleteId=r.id; modal.classList.remove('hidden'); });
        tbody.appendChild(tr);
      }
    }

    // 刪除
    document.getElementById('btnCancelDel').addEventListener('click', () => { pendingDeleteId=null; modal.classList.add('hidden'); });
    document.getElementById('btnConfirmDel').addEventListener('click', async () => {
      if (!pendingDeleteId) return;
      const { error } = await sb.from('bookings').delete().eq('id', pendingDeleteId);
      modal.classList.add('hidden'); pendingDeleteId=null;
      if (error) alert('刪除失敗：'+error.message); else load();
    });

    // 控件事件
    filterDate.addEventListener('change', load);
    filterQuery.addEventListener('input', () => debounce(load,250)());
    sortBy.addEventListener('change', load);
    btnReload.addEventListener('click', load);
    btnExport.addEventListener('click', exportCsv);

    // 匯出 CSV
    async function exportCsv() {
      const { data, error } = await sb.from('bookings').select('*').order('date',{ascending:true}).order('start_time',{ascending:true});
      if (error) return alert('匯出失敗：'+error.message);
      const rows = [['id','date','start_time','end_time','name','phone','notes','created_at']];
      (data||[]).forEach(r => rows.push([r.id,r.date,r.start_time,r.end_time,r.name,r.phone,r.notes||'',r.created_at]));
      const csv = rows.map(r => r.map(s => '"' + String(s??'').replace(/"/g,'""') + '"').join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob); const a=document.createElement('a');
      a.href=url; a.download='bookings-'+new Date().toISOString().slice(0,10)+'.csv';
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    // utils
    function esc(s) { return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }
    function fmt(iso) { if(!iso) return ''; const d=new Date(iso); const p=n=>String(n).padStart(2,'0'); return d.getFullYear()+'-'+p(d.getMonth()+1)+'-'+p(d.getDate())+' '+p(d.getHours())+':'+p(d.getMinutes()); }
    function debounce(fn,ms) { let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args),ms); } }
  </script>
</body>
</html>
